# shell 脚本的构成

shell 脚本只有以下内容元素：

- shebang
- 命令
- keyword（例如 if、function）
- 符号
  - 有特定语义的符号（例如 $、括号）
  - 分隔符（例如空格、分号）
- 字符
- 注释

<br>

# shell 命令的基本概念

命令的基本单位是“行”

一行命令的基本结构是：command + [options]

第一个单词，一定是命令

命令只有以下四种类型：

- 可执行程序
  - 直接指向某个文件：绝对路径 / 相对路径
  - 一个单词，系统自动添加 path 后组成绝对路径
- shell 内置命令（builtins）
- shell 函数（function）
- alias

<br>

# shell 脚本的解析机制

shell 脚本不过是命令的集合

默认情况下，解释器将文本划分为行，每一行视为一个命令，从上到下依次执行

每行命令又被分割为一个个单词，除了第一个单词被视为命令，其他单词均视为字符串

凡是能够在命令行中运行的命令，都可以写到 shell 脚本中

此外，shell 脚本还提供了一些基本的程序语言能力，包括：

- 字符展开（含变量）
- 函数（含局部变量）
- 流程控制
- 数组

<br>

### 分号

shell 将分号视为 command seperator

命令行：命令以行为单位

默认以 `\n` 作为划分行的分隔符

如果多个命令写在一行，就需要用分号作为分隔符

```shell
command1; command2
```

<br>

# shell 脚本的运行机制

### 退出状态

每个命令执行结束，都会有一个退出状态，可通过 `$?` 访问上一个命令的退出状态

<br>

# 字符展开

默认情况下，shell 会将命令以外的字符，一律解析为字符串。只有当遇到特殊符号或关键字，才会改用特定的解析规则

遇到特殊符号时，先解析或计算出表达式的结果，再代入原脚本，这个过程称为展开（Expansion）

### 路径名展开

只要单词内包含通配符，则展开为一组文件名

与路径名展开相关的通配符：

- `*` 任意数量的任意字符
- `?` 任意一个字符（不能是零个）
- `[characters]` 字符集中的任意一个字符（不能是零个）
- `[!characters]` 不属于字符集中的任意一个字符（不能是零个）
- `[:class:]` 特定字符集中的任意一个字符（不能是零个）

> 如果路径展开失败，表达式将被视为字符串

> ~ 自动展开为家目录路径

<br>

### 算数表达式展开

`$((expression))`

<br>

### 花括号展开

用于生成多个字符串

- 数字序列：`{1..9}`
- 字母序列：`{a..f}`
- 字符组合：`{1,a,2,b}`

支持嵌套

<br>

### 变量展开

又称参数展开。叫变量展开更贴切，不过某些“变量”不符合变量命名规则，例如 `$?`，因此叫参数更准确。以下不细究该差异，统一叫变量

只要遇到 `$` 符号就进行变量展开

变量分为内置变量（例如：`$PATH`）和自定义变量

查看所有内置变量：`printenv | less`

变量和字符串拼接时，用 `${}` 标识哪部分是变量

```shell
host=xx.com
url=${host}/path
```

<br>

### 命令代换

`$(command)`

> 另一种语法是反引号 ``

<br>

### 避免展开

1. 引号

引号在 shell 中的一个作用是避免展开

自动展开导致非预期结果的案例：

```shell
echo $100.00 # $1 被当作变量展开
```

双引号：除了 $、\ 和 `，其他特殊符号都保持原状（包括空格）

双引号允许在字符串中实现：变量展开、算数展开、命令替换

单引号：禁止单词分割和所有展开

2. 转义

要禁止特殊符号展开，可用 \ 转义

<br>

# 语法

### 变量

变量名仅支持数字、字母、下划线，且不能以数字开头

使用*任何未定义的变量，都会返回空值*，而不是报错

常量的两种声明方式：

```shell
readonly var
readonly var=value

declare -r var
declare -r varName=value
```

> 赋值语句，变量名、等号和变量值之间不能有空格

<br>

### 函数

一个函数必须至少包含一条命令

函数有两种声明形式：

```shell
a () {
  # command
}

function b () {
  # command
}
```

参数定义在 `$1`、`$2`... 这样的变量中：

```shell
Hello () {
   echo "$1 $2"
}
```

调用函数：

```shell
funct # 无参数调用
funct a b # 传参调用
```

函数的返回值定义在 `$?`：

```shell
Hello () {
  return 10
}

Hello

echo "Return value is $?"
```

以上用法印证：在 shell 中，函数是一种命令

<br>

### 条件

```shell
if commands; then
    commands
else
    commands
fi
```

if 条件判断的本质，是判断*命令执行的退出状态*

```bash
$ type true
true is a shell builtin
$ true
$ echo $?
0                      
$ false
$ echo $?
1                      
```

可见在 shell 中，true 和 false 是一种命令

<br>

### 测试表达式

有两种写法：

```shell
test expression

[ expression ] # 更流行
```

[] 两侧需加空格，因为按照 shell 的解析方式，不加空格，单词分割后，括号会和单词粘连在一起

```shell
if [a = a]; then echo 1; fi # [a: command not found
```

测试表达式的执行结果是 true 或 false

测试表达式的类型：

- 文件：例如测试文件是否存在
- 字符串：例如判断是否相同
- 整数：例如判断大小

